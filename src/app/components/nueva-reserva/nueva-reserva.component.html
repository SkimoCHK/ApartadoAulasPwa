<div class="reserva-container">
  <!-- Header -->
  <header class="header">
    <button class="back-button" (click)="onBack()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
    </button>
    <h1 class="header-title">Nueva Reserva</h1>
  </header>

  <!-- Progress Steps -->
  <div class="progress-container">
    <div
      class="progress-step"
      [class.active]="currentStep >= 1"
      [class.completed]="currentStep > 1"
    >
      <div class="step-circle">1</div>
      <span class="step-label">Aula</span>
    </div>
    <div class="progress-line" [class.active]="currentStep > 1"></div>
    <div
      class="progress-step"
      [class.active]="currentStep >= 2"
      [class.completed]="currentStep > 2"
    >
      <div class="step-circle">2</div>
      <span class="step-label">Fecha</span>
    </div>
    <div class="progress-line" [class.active]="currentStep > 2"></div>
    <div
      class="progress-step"
      [class.active]="currentStep >= 3"
      [class.completed]="currentStep > 3"
    >
      <div class="step-circle">3</div>
      <span class="step-label">Horario</span>
    </div>
    <div class="progress-line" [class.active]="currentStep > 3"></div>
    <div class="progress-step" [class.active]="currentStep >= 4">
      <div class="step-circle">4</div>
      <span class="step-label">Confirmar</span>
    </div>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Error Message -->
    <div class="error-message" *ngIf="error">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <span>{{ error }}</span>
    </div>

    <!-- Step 1: Seleccionar Aula -->
    <div class="step-content" *ngIf="currentStep === 1">
      <h2 class="step-title">Selecciona un aula</h2>

      <div class="loading-spinner" *ngIf="loading">
        <div class="spinner"></div>
        <p>Cargando aulas...</p>
      </div>

      <div class="aulas-grid" *ngIf="!loading">
        <div
          class="aula-card"
          *ngFor="let aula of aulas"
          (click)="onSelectAula(aula)"
          [class.disabled]="!aula.estatus"
        >
          <div class="aula-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="9" x2="15" y2="9"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
          </div>
          <div class="aula-info">
            <h3 class="aula-nombre">{{ aula.nombre }}</h3>
            <p class="aula-descripcion" *ngIf="aula.descripcion">
              {{ aula.descripcion }}
            </p>
            <div class="aula-capacidad">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              <span
                >Capacidad: {{ aula.capacidadEstudiantes }} estudiantes</span
              >
            </div>
          </div>
          <div class="aula-arrow">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Seleccionar Fecha -->
    <div class="step-content" *ngIf="currentStep === 2">
      <h2 class="step-title">Selecciona la fecha</h2>

      <div class="selected-info">
        <div class="info-label">Aula seleccionada:</div>
        <div class="info-value">{{ aulaSeleccionada?.nombre }}</div>
      </div>

      <div class="form-group">
        <label for="fecha">Fecha de reserva</label>
        <input
          type="date"
          id="fecha"
          class="form-input"
          [(ngModel)]="fechaSeleccionada"
          (change)="onFechaChange()"
          [min]="fechaSeleccionada"
        />
      </div>

      <div class="loading-spinner" *ngIf="loadingDisponibilidad">
        <div class="spinner"></div>
        <p>Cargando disponibilidad...</p>
      </div>
    </div>

    <!-- Step 3: Seleccionar Horario -->
    <div class="step-content" *ngIf="currentStep === 3">
      <h2 class="step-title">Selecciona el horario</h2>

      <!-- Indicador de modo offline -->
      <div *ngIf="!isOnline" class="offline-info">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"
          ></path>
        </svg>
        <span
          >üì± Modo offline - Mostrando horarios disponibles de 7:30 AM a 3:00
          PM. La disponibilidad real se verificar√° al conectarse.</span
        >
      </div>

      <div class="selected-info">
        <div class="info-row">
          <span class="info-label">Aula:</span>
          <span class="info-value">{{ aulaSeleccionada?.nombre }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Fecha:</span>
          <span class="info-value">{{ fechaSeleccionada }}</span>
        </div>
      </div>

      <div class="horarios-grid">
        <button
          class="horario-card"
          *ngFor="let horario of disponibilidad"
          (click)="onSelectHorario(horario)"
          [class.disponible]="horario.disponible"
          [class.ocupado]="!horario.disponible"
          [class.selected]="horarioSeleccionado === horario"
          [disabled]="!horario.disponible"
        >
          <div class="horario-time">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span
              >{{ formatTime(horario.horaInicio) }} -
              {{ formatTime(horario.horaFin) }}</span
            >
          </div>
          <div class="horario-status">
            <span *ngIf="horario.disponible" class="status-disponible"
              >Disponible</span
            >
            <span *ngIf="!horario.disponible" class="status-ocupado"
              >Ocupado</span
            >
          </div>
        </button>
      </div>
    </div>

    <!-- Step 4: Confirmar Reserva -->
    <div class="step-content" *ngIf="currentStep === 4">
      <h2 class="step-title">Confirma tu reserva</h2>

      <div class="resumen-card">
        <h3 class="resumen-title">Resumen de tu reserva</h3>

        <div class="resumen-item">
          <div class="resumen-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </svg>
          </div>
          <div class="resumen-info">
            <div class="resumen-label">Aula</div>
            <div class="resumen-value">{{ aulaSeleccionada?.nombre }}</div>
          </div>
        </div>

        <div class="resumen-item">
          <div class="resumen-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </div>
          <div class="resumen-info">
            <div class="resumen-label">Fecha</div>
            <div class="resumen-value">{{ fechaSeleccionada }}</div>
          </div>
        </div>

        <div class="resumen-item">
          <div class="resumen-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
          </div>
          <div class="resumen-info">
            <div class="resumen-label">Horario</div>
            <div class="resumen-value">
              {{ formatTime(horarioSeleccionado!.horaInicio) }} -
              {{ formatTime(horarioSeleccionado!.horaFin) }}
            </div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="motivo">Motivo de la reserva</label>
        <textarea
          id="motivo"
          class="form-textarea"
          [(ngModel)]="motivo"
          placeholder="Describe el motivo de tu reserva..."
          rows="4"
          maxlength="500"
        ></textarea>
        <div class="char-counter">{{ motivo.length }}/500</div>
      </div>

      <button
        class="btn-confirmar"
        (click)="onConfirmarReserva()"
        [disabled]="!isFormValid() || loading"
      >
        <span *ngIf="!loading">Confirmar Reserva</span>
        <span *ngIf="loading">
          <div class="btn-spinner"></div>
          Procesando...
        </span>
      </button>
    </div>

    <!-- Estado de conexi√≥n -->
    <div *ngIf="!isOnline" class="offline-banner">
      <span
        >üì± Modo offline - Las reservas se sincronizar√°n cuando haya
        conexi√≥n</span
      >
    </div>

    <!-- Reservas pendientes de sincronizar -->
    <div *ngIf="pendingReservas.length > 0" class="pending-reservas">
      <h3>Reservas pendientes de sincronizar:</h3>
      <div
        *ngFor="let reserva of pendingReservas"
        class="pending-item"
        [ngClass]="reserva.syncStatus"
      >
        <div class="pending-info">
          <p>
            <strong>{{
              reserva.aulaInfo?.nombre || "Aula " + reserva.aulaId
            }}</strong>
          </p>
          <p>
            {{ reserva.fecha }} - {{ formatTime(reserva.horaInicio) }} a
            {{ formatTime(reserva.horaFin) }}
          </p>
          <p>
            <small>{{ reserva.motivo }}</small>
          </p>
          <p class="status" [ngClass]="reserva.syncStatus">
            <span *ngIf="reserva.syncStatus === 'pending'">‚è≥ Pendiente</span>
            <span *ngIf="reserva.syncStatus === 'syncing'"
              >üîÑ Sincronizando...</span
            >
            <span *ngIf="reserva.syncStatus === 'synced'">‚úÖ Sincronizado</span>

          </p>
        </div>
        <div class="pending-actions">
          <button
            *ngIf="reserva.syncStatus === 'error' && isOnline"
            (click)="retryReserva(reserva)"
            class="btn-retry"
          >
            Reintentar
          </button>
          <button
            *ngIf="reserva.syncStatus !== 'synced'"
            (click)="deletePendingReserva(reserva.id)"
            class="btn-delete"
          >
            Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
